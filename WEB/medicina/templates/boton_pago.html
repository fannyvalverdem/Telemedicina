{% extends 'index_paciente.html' %}

{% block import %}
<script src="https://code.jquery.com/jquery-1.11.3.min.js" charset="UTF-8"></script>

<link href="https://cdn.paymentez.com/js/ccapi/stg/paymentez.min.css" rel="stylesheet" type="text/css" />
<script src="https://cdn.paymentez.com/js/ccapi/stg/paymentez.min.js" charset="UTF-8"></script>
<script src="https://cdn.paymentez.com/checkout/1.0.1/paymentez-checkout.min.js"></script>
{% endblock %}

{% block contenido %}
<div class="container">
	<div class="row">
		<div id="titulo" class="col-xl-12" style="text-align: center;">
			<h2>Realizar pago</h2>
			<br>
			<br>
		</div>
		<div class="row">
			<div class="col-12">
				<div class="paymentez-form" id="my-card" data-capture-name="true"></div>
				<button class="js-paymentez-checkout">Purchase</button>
				</div>

			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block script %}
<script>
		var myCard = $('#my-card');
		var cardToSave = myCard.PaymentezForm('card');
		if(cardToSave == null){
		  alert("Invalid Card Data");
		}


	//Init library

	/**
	  * Init library
	  *
	  * @param env_mode `prod`, `stg`, `local` to change environment. Default is `stg`
	  * @param paymentez_client_app_code provided by Paymentez.
	  * @param paymentez_client_app_key provided by Paymentez.
	  */
	Paymentez.init('stg', 'PAYMENTEZ_CLIENT_APP_CODE', 'PAYMENTEZ_CLIENT_APP_KEY');



	//getSessionId
	var session_id = Paymentez.getSessionId();

	//Reading Values
	var myCard = $('#my-card');
	var cardNumber = myCard.PaymentezForm('cardNumber');
	var cardType = myCard.PaymentezForm('cardType');
	var name = myCard.PaymentezForm('name');
	var expiryMonth = myCard.PaymentezForm('expiryMonth');
	var expiryYear = myCard.PaymentezForm('expiryYear');
	var fiscalNumber = myCard.PaymentezForm('fiscalNumber');
	var validationOption = myCard.PaymentezForm('validationOption');

	//Functions
	$('#my-card').PaymentezForm('function')

	//Card Type from Card Number
	var cardNumber = '4242 4242 4242 4242'; // Spacing is not important
	var cardType = PaymentezForm.cardTypeFromNumber(cardNumber);
	

	//Cleaning and Masking
	
	// var formatMask = 'XXXX XXXX XXXX XXXX'; // You can manually define an input mask
	// var formatMask = 'XX+X X XXXX XXXX XXXX'; // You can add characters other than spaces to the mask
	var formatMask = PaymentezForm.CREDIT_CARD_NUMBER_VISA_MASK; // Or use a standard mask.
	var cardNumber = '424 2424242 42   42 42';
	var cardNumberWithoutSpaces = PaymentezForm.numbersOnlyString(cardNumber);
	var formattedCardNumber = PaymentezForm.applyFormatMask(cardNumberWithoutSpaces, formatMask);


	//Card expiration date
	var month = "3";
	var year = "19";
	var valid = PaymentezForm.isExpiryValid(month, year);


var paymentezCheckout = new PaymentezCheckout.modal({
      client_app_code: 'TPP2-EC-CLIENT', // Client Credentials Provied by Paymentez
      client_app_key: 'sDAwQAdBqetYhVZFFLpOg6FU2cmjF0', // Client Credentials Provied by Paymentez
      locale: 'es', // User's preferred language (es, en, pt). English will be used by default.
      env_mode: 'stg', // `prod`, `stg` to change environment. Default is `stg`
      onOpen: function() {
          console.log('modal open');
      },
      onClose: function() {
          console.log('modal closed');
      },
      onResponse: function(response) { // The callback to invoke when the Checkout process is completed
          
          /*
            In Case of an error, this will be the response.
            response = {
              "error": {
                "type": "Server Error",
                "help": "Try Again Later",
                "description": "Sorry, there was a problem loading Checkout."
              }
            }

            When the User completes all the Flow in the Checkout, this will be the response.
            response = {
               "transaction": {
                  "status": "success", // success, failure or pending
                  "payment_date": "2017-09-26T21:03:04",
                  "amount": 99.0,
                  "authorization_code": "148177",
                  "installments": 1,
                  "dev_reference": "referencia",
                  "message": "Operation Successful",
                  "carrier_code": "6",
                  "id": "CI-490", // transaction_id
                  "status_detail": 3 // for the status detail please refer to: https://paymentez.github.io/api-doc/#status-details
               },
               "card": {
                  "bin": "453254",
                  "status": "valid",
                  "token": "",
                  "expiry_year": "2020",
                  "expiry_month": "9",
                  "transaction_reference": "CI-490",
                  "type": "vi",
                  "number": "8311"
              }
           }

          */
          console.log('modal response');
          document.getElementById('response').innerHTML = JSON.stringify(response);            
      }
  });

  var btnOpenCheckout = document.querySelector('.js-paymentez-checkout');
  btnOpenCheckout.addEventListener('click', function(){
    // Open Checkout with further options:
    paymentezCheckout.open({
      user_id: '1234',
      user_email: 'test@paymentez.com', //optional        
      user_phone: '7777777777', //optional
      order_description: '1 Green Salad',
      order_amount: 1500,
      order_vat: 0,
      order_reference: '#234323411',
      //order_installments_type: 2, // optional: For Colombia an Brazil to show installments should be 0, For Ecuador the valid values are: https://paymentez.github.io/api-doc/#payment-methods-cards-debit-with-token-installments-type
      //order_taxable_amount: 0, // optional: Only available for Ecuador. The taxable amount, if it is zero, it is calculated on the total. Format: Decimal with two fraction digits.
      //order_tax_percentage: 10 // optional: Only available for Ecuador. The tax percentage to be applied to this order.
    });
  });
  
  // Close Checkout on page navigation:
  window.addEventListener('popstate', function() {
    paymentezCheckout.close();
  });


	</script>
{% endblock %}